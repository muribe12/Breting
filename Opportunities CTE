WITH Oppty AS 
        (
        
        Select mel.* FROM 
                      (
                      SELECT
                      a.id,
                      ROW_NUMBER () OVER (PARTITION BY a.id 
                      ORDER BY MAX(a.systemmodstamp) DESC) AS "rnk",
                      MAX(a.systemmodstamp) AS Oppty_Date,
                      a.opportunity_id__c,
                      a.stagename, 
                      a.account_industry
                      
                      FROM history.vmc_vmstar_opportunity a
                      
                      GROUP BY a.id,
                      a.opportunity_id__c, 
                      a.stagename, 
                      a.account_industry
                      
                      ORDER BY Oppty_Date DESC
                      
                      ) as mel
                      WHERE mel.rnk=1
                  )
