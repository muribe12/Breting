WITH 
xxvm_xaas_fund_redeem_rpt_v as (
SELECT *
            FROM starshot_lake_restricted.xxvm_xaas_fund_redeem_rpt_v
            WHERE SUBSTRING(pa__collection_id, instr(pa__collection_id, '|') + 1) = (
                    SELECT MAX(SUBSTRING(pa__collection_id, instr(pa__collection_id, '|') + 1))
                    FROM starshot_lake_restricted.xxvm_xaas_fund_redeem_rpt_v
                    )), xxvm_sdp_account as (
                    SELECT xs.*
            FROM starshot_lake_restricted.xxvm_sdp_account AS xs
            INNER JOIN (
                SELECT account_id AS natural_key,
                    MAX(pa__processed_ts) AS last_snaphot_timestamp
                FROM starshot_lake_restricted.xxvm_sdp_account
                GROUP BY account_id
                ) last_seen_xs ON last_seen_xs.natural_key = xs.account_id
                AND last_seen_xs.last_snaphot_timestamp = xs.pa__processed_ts),
                xxvm_ems_ent_account as (
                   SELECT xs.*
            FROM starshot_lake_restricted.xxvm_ems_ent_account AS xs
            INNER JOIN (
                SELECT ent_account_id AS natural_key,
                    MAX(pa__processed_ts) AS last_snaphot_timestamp
                FROM starshot_lake_restricted.xxvm_ems_ent_account
                GROUP BY ent_account_id
                ) last_seen_xs ON last_seen_xs.natural_key = xs.ent_account_id
                AND last_seen_xs.last_snaphot_timestamp = xs.pa__processed_ts),
   xxvm_epp_fund_details_v as (          
SELECT xe.*
                FROM starshot_lake_restricted.xxvm_epp_fund_details_v AS xe
                WHERE SUBSTRING(pa__collection_id, instr(pa__collection_id, '|') + 1) = (
                        SELECT MAX(SUBSTRING(pa__collection_id, instr(pa__collection_id, '|') + 1))
                        FROM starshot_lake_restricted.xxvm_epp_fund_details_v
                        )),
  xxvm_epp_fund as (
               SELECT xs.*
            FROM starshot_lake_restricted.xxvm_epp_fund AS xs
            INNER JOIN (
                SELECT fund_id AS natural_key,
                    MAX(pa__processed_ts) AS last_snaphot_timestamp
                FROM starshot_lake_restricted.xxvm_epp_fund
                GROUP BY fund_id
               ) last_seen_xs ON last_seen_xs.natural_key = xs.fund_id
                AND last_seen_xs.last_snaphot_timestamp = xs.pa__processed_ts         
                        ),
fact_org_subscriptions as (
            SELECT xz.*
            FROM vmc_dw.fact_org_subscriptions AS xz
            INNER JOIN (
                SELECT dim_org_id AS natural_key,
                  MAX(ss__processed_ts) AS last_snaphot_timestamp
                FROM vmc_dw.fact_org_subscriptions 
                GROUP BY dim_org_id
               ) last_seen_xz ON last_seen_xz.natural_key = xz.dim_org_id
                AND last_seen_xz.last_snaphot_timestamp = xz.ss__processed_ts         
                        ),
CTE AS
  (SELECT 
                   CASE
                     WHEN (fr.sku_description ilike '%govcloud%') THEN 'AWS GovCloud'
                     WHEN (fr.sku_description like '%AWS%') THEN 'AWS'
                     WHEN (fr.sku_description like '%Cost Insight%') THEN 'Cost Insight'
                     WHEN (fr.sku_description like '%Network Insight%') THEN 'Network Insight'
                     WHEN (fr.sku_description like '%Horizon%') THEN 'Horizon'
                     WHEN (fr.sku_description ilike '%wavefront%') THEN 'Wavefront'
                  END as "product family",
                   fr.fund_name as Fund_Name,
                   AVG (fr.outstanding_balance) AS "Overage Amount",
                       fr.fund_id,
                   fr.ea_number AS ea_number,
                       --si.account_name AS "Ea Name",
                       ea.ent_account_name AS Ea_Name,
                       fr.fund_owner_email AS Fund_Owner,
                       fr.currency as "Currency",
                       fr.fund_name AS "SO",
                       fr.redemption_date AS "Redeemed Fund Date",
                       fr.billing_start_date AS "Fund Billing Start Date",
                       fr.billing_end_date AS "Fund Billing End Date",
                       count (fr.ea_number) AS "Total",
                       avg (CAST(fr.ea_number AS INT)) as "Customer Account",
                       --AVG(CAST(money AS INT))
                       fr.group_id as Group_ID,
                       fr.group_name as "Group Name",
                       fr.sid,
                       sppd.fund_start_date as "Fund Start Date",
                       --to_date(((sppd.fund_start_date) :: character varying) :: text,
                        --('YYYY-MM-DD' :: character varying) :: text) as "Fund Start Date",
                       sppd.fund_end_date as "Fund End Date",
                       sppd.tokens_purchased,
                       sppd.tokens_remaining,
                       fr.sku,
                       fr.sku_description,
                       sppd.disti_prm_id,
                       sdpx.offer_type
   FROM xxvm_xaas_fund_redeem_rpt_v fr
   --starshot_lake_restricted.xxvm_xaas_fund_redeem_rpt_v
   LEFT JOIN xxvm_ems_ent_account ea
   --starshot_lake_restricted.xxvm_ems_ent_account
     ON (fr.ea_number = ea.ent_account_number)    
   LEFT JOIN xxvm_epp_fund spp
   --starshot_lake_restricted.xxvm_epp_fund
     ON (fr.fund_id=spp.fund_id)
   LEFT JOIN xxvm_epp_fund_details_v sppd
   --starshot_lake_restricted.xxvm_epp_fund_details_v
     ON (spp.fund_id = sppd.fund_id )
  LEFT JOIN fact_org_subscriptions sdpx
    ON (fr.sid = sdpx.dim_subscription_id)
   WHERE fr.outstanding_balance > 0
   AND fr.fund_id NOT IN (99999,138674,138675,138676,138679,139474,139504,139505,139573,139574,139575,139576,139577,140020,140080,140081,140104,140128,140131,140161,140167,140180,140184,140195,140233,140235,140245,140301,140313,140315,140364,140443,140445,140503,140624,140625,140775,140785,140787,140789,140843,141010,141011,141016,141017,141018,141022,141023,141034,141048,141069,141070,141074,141088,141094,141098,141111,141113,141138,141143,141146,141165,141167,141168,141172,141174,141177,141179,141182,141183,141185,141186,141187,141188,141189,141190,141192,141193,141197,141198,141201,141202,141213,141218,141219,141237,141258,141262,141291,141292,141301,141352,141354,141355,141356,141373,141374,141375,141376,141382,141383,141385,141386,141439,141558,141635,141649,141869,141871,141906,141907,142751,143067,143408,143558,143678,143679,143727,143734,143736,143737,143738,143739,143748,143897,143912,143932,143946,143951,143960,144580,144829,144938,145261,145421,146222,146245,147490,147659,147670,147990,148501,148546,148547,148549,148550,148551,148552,148553,148569,148571,148574,148576,148577,148581,148727,148730,148731,148732,148733,148734,148735,148736,148995,151269,151395,151592,151791,151942,152049,152943,153656,153951,154223,154263,154492,154733,154814,154965,155025,155026,155027,155028,155029,155066,155067,155200,155201,155221,155248,155249,155250,155258,155259,155262,155263,155383,155445,155541,155542,155547,155597,155599,155600,155629,155630,155632,155656,155657,155664,155665,155721,155739,155740,155743,155805,155821,155880,155929,155975,156010,156011,156029,156069,156070,156071,156072,156073,156074,156075,156086,156099,156210,156326,156505,156510,156511,156544,156564,156605,156618,156628,156647,156670,156672,156675,156726,156732,156737,156742,156743,156845,156850,156851,156984,157045,157103,157106,157107,157246,157335,157358,157377,157400,157465,157511,157537,157578,157582,157624,157632,157633,157636,157637,157707,157772,157826,157928,157929,157935,158111,158166,158167,158245,158318,158357,158419,158572,158573,158702,158737,158814,158902,158903,158904,158921,158946,158954,158969,158970,158987,158988,159128,159129,159493,159501,159652,159736,159828,159829,159905,160320,160325,160418,160419,160420,
160450,160490,160496,160497,160503,160504,160538,160543,160576,160592,160595,160598,160599,160605,160634,160635,160636,160637,160654,160655,160656,160661,160662,160695,160724,160772,160783,160784,160920,160953,160965,161006,161007,161013,161043,161044,161091,161107,161108,161109,161245,161246,161247,161257,161258,161263,161283,161284,161285,161288,161301,161312,161313,161314,161315,161316,161317,161318,161320,161367,161368,161399,161400,161403,161456,161457,161458,161459,161460,161461,161462,161488,161508,161511,161542,161543,161613,161614,161615,161626,161627,161702,161704,161705,161930,161936,161937,161968,162071,162075,162210,162305,162379,162485,162517,162767,162787,162788,162848,162978,162993,162997,163000,163001,163027,163038,163086,163122,163123,163162,163214,163220,163441,163471,163472,163473,163557,163575,163579,163584,163585,163608,163682,163683,163809,163810,163811,163812,163846,163916,163943,164026,164117,164173,164174,164175,164176,164177,164178,164179,164180,164181,164182,164183,164184,164186,164187,164188,164189,164190,164191,164192,164193,164194,164195,164196,164197,164198,164199,164200,164201,164328,164424,164425,164426,164428,164503,164564,164574,164575,164628,164631,164642,164684,164685,164686,164690,164702,164755,164756,164757,164758,164759,165035,165037,165095,165132,165133,165134,165136,165137,165138,165139,165145,165181,165182,165235,165236,165237,165238,165239,165240,165241,165242,165243,165244,165245,165246,165247,165248,165249,165250,165251,165252,165253,165254,165255,165256,165257,165258,165259,165260,165261,165262,165263,165264,165265,165266,165267,165268,165269,165270,165271,165272,165273,165274,165275,165276,165277,165278,165279,165280,165281,165282,165283,165284,165285,165286,165345,165346,165370,165421,165422,165423,165424,165425,165426,165427,165428,165437,165527,165528,165529,165530,165531,165532,165533,165534,165535,165544,165545,165546,165605,165606,165607,165608,165682,165812,165897,165934,165935,165936,165937,165938,165939,165940,165954,165955,165956,165974,165975,165976,165977,165978,165979,165980,165981,165983,165984,166093,166094,166095,166152,166159,166160,166215,166216,166247,166257,166258,166296,166297,166298,166299,166314,166315,
166316,166318,166319,166320,166321,166353,166354,166382,166389,166418,166419,166427,166432,166433,166435,166436,166437,166454,166505,166555,166560,166561,166596,166643,166664,166739,166743,166854,166857,166869,166888,166889,166890,166891,166892,166893,166894,166895,166896,166898,166899,166900,166901,166902,166903,166904,166905,166906,166910,166911,166912,166913,166914,166915,166916,166917,166918,166919,166920,166921,166922,166923,166924,166925,166926,166927,166928,166929,166930,166931,166932,166933,166934,166935,166936,166937,166938,166941,166944,166945,166946,166947,166949,166952,166966,166980,166981,166989,166990,167012,167020,167025,167046,167047,167048,167087,167088,167095,167099,167137,167148,167152,167164,167165,167166,167167,167168,167169,167170,167171,167172,167173,167174,167175,167176,167177,167181,167182,167185,167215,167216,167220,167221,167222,167223,167239,167241,167242,167273,167276,167281,167282,167289,167290,167296,167297,167301,167302,167303,167304,167305,167306,167310,167311,167312,167323,167324,167325,167326,167331,167334,167349,167357,167358,167359,167391,167399,167400,167410,167411,167412,167445,167448,167449,167454,167455,167456,167461,167463,167472,167482,167483,167508,167511,167519,167520,167527,167542,167552,167573,167574,167581,167605,167609,167610,167614,167616,167626,167627,167647,167650,167679,167680,167681,167714,167730,167787,167798,167799,167811,167813,167814,167815,167816,167818,167819,167820,167852,167953,167955,167956,167999,168005,168007,168008,168010,168011,168075,168076,168092,168097,168101,168102,168144,168145,168157,168161,168170,168216,168217,168233,168236,168294,168295,168363,168367,168375,168376,168377,168393,168394,168395,168396,168397,168399,168462,168464,168465,168484,168491,168502,168506,168561,168565,168573,168574,168581,168645,168718,168726,168757,168786,168790,168791,168792,168815,168864,168865,168910,168911,168912,169041,169045,169052,169057,169058,169122,169123,169141,169151,169152,169187,169220,169277,169278,169279,169332,169333,169401,169402,169403,169407,169408,169509,169510,169515,169553,169554,169555,169628,169629,169694,169695,169723,169724,169746,169790,169791,169804,169805,169806,169880,169893,169894,169895,169896,
169897,169905,169910,169977,169997,170014,170049,170050,170076,170109,170113,170121,170122,170173,170202,170284,170314,170344,170372,170412,170413,170422,170426,170427,170468,170470,170471,170472,170474,170484,170485,170487,170501,170503,170504,170505,170509,170513,170686,170689,170694,170700,170704,170707,170718,170719,170725,170726,170730,170732,170736,170739,170741,170743,170747,170811,170819,170822,170834,170837,170840,170842,170876,170911,170989,170994,170996,170998,171038,171130,171131,171163,171164,171165,171169,171175,171176,171180,171181,171182,171192,171197,171232,171233,171261,171262,171265,171266,171315,171328,171336,171341,171378,171379,171380,171381,171389,171445,171452,171453,171454,171455,171456,171457,171511,171512,171634,171707,171708,171728,171771,171772,171798,171849,171851,171852,171937,171938,171954,172028,172057,172059,172192,172210,172211,172237,172238,172239,172256,172304,172306,172341,172466,172630,172709,172784,172786,172793,172810,172817,172972,173085,173201,173233,173238,173378,173379,173551,173762,173771,173782,173813,173865,173887,173888,173890,174082,174088,174089,174168,174277,174320,174374,174375,174470,174471,174474,174520,174535,174550,174731,174927,174928,174929,174930,174975,174990,175068,175112,175239,175240,175241,175242,175261,175262,175279,175280,175281,175282,175357,175358,175403,175461,175462,175523,175656,175677,175678,175679,175871,175872,175894,175895,176022,176023,176030,176031,176098,176099,176161,176181,176182,176193,176213,176226,176227,176258,176259,176260,176261,176274,176287,176305,176319,176320,176321,176322,176329,176332,176358,176410,176411,176454,176458,176460,176505,176507,176515,176516,176552,176553,176561,176563,176607,176627,176634,176650,176680,176747,176750,176755,176756,176763,176822,176823,176824,176825,176827,176845,176920,176925,176947,176997,176998,176999,177008,177009,177070,177140,177177,177189,177197,177218,177221,177222,177223,1177267,177331,177339,177379,177390,177391,177421,177470,177471,177475,177478,177513,177531,177534,177535,177536,177568,177569,177570,177571,177585,177617,177632,177682,177691,177703,177704,177763,177771,177772,177776,177796,177797,177815,177834,177844,177860,177890,177891,
177892,177915,177916,177939,177975,177980,177981,178005,178015,178056,178057,178097,178098,178115,178131,178132,178133,178139,178172,178194,178230,178231,178235,178244,178266,178270,178271,178395,178417,178474,178475,178501,178509,178511,178519,178536,178627,178628,178727,178768,178769,178781,178782,178849,178854,178858,178910,178957,178975,178976,178979,178980,178987,179031,179034,179073,179074,179111,179195,179202,179207,179230,179286,179325,179326,179329,179336,179337,179355,179358,179360,179425,179531,179540,179541,179542,179545,179548,179549,179578,179623,179625,179641,179644,179648,179698,179703,179709,179715,179773,179826,179827,179828,179829,179830,179833,179834,179869,179880,179881,179937,179939,179940,179984,179989,179990,179991,179992,179993,180035,180036,180037,180042,180059,180073,180103,180121,180147,180148,180154,180156,180160,180168,180198,180215,180216,180222,180223,180225,180226,180227,180228,180260,180263,180270,180282,180331,180388,180389,180390,180424,180473,180474,180475,180509,180512,180514,180515,180574,180605,180616,180635,180636,180653,180678,180679,180730,180731,180734,180803,180804,180848,180849,180850,180870,180904,180928,180931,180932,181038,181147,181148,181152,181153,181154,181155,181158,181211,181273,181274,181275,181276,181277,181333,181334,181335,181336,181402,181419,181420,181421,181424,181484,181487,181544,181572,181589,181591,181592,181593,181636,181638,181663,181695,181697,181767,181768,181808,181813,181826,181886,181896,181904,181943,182005,182006,182014,182042,182100,182109,182187,182194,182200,182248,182249,182290,182293,182294,182295,182347,182368,182447,182488,182489,182748,182749,182820,182821,182822,182823,182831,182832,182926,182927,182928,182930,182990,183011,183060,183065,183066,183077,183078,183079,183096,183102,183103,183127,183164,183165,183166,183167,183168,183182,183183,183184,183185,183211,183321,183322,183323,183324,183348,183349,183405,183406,183411,183461,183462,183463,183470,183471,183474,183475,183527,183528,183529,183530,183556,183558,183559,183560,183600,183603,183638,183765,183815,183818,183841,183846,183847,183925,183926,183928,183933,183934,183968,184040,184041,184042,184043,184058,184094,184095,184133,
184134,184143,184148,184149,184172,184177,184180,184184,184186,184192,184193,184268,184284,184288,184289,184340,184380,184413,184415,184421,184475,184476,184477,184487,184488,184525,184527,184585,184586,184587,184621,184622,184623,184624,184625,184627,184628,184629,184630,184631,184649,184729,184733,184738,184742,184753,184762,184769,184792,184793,184794,184834,184835,184844,184845,184846,184849,184850,184851,184852,184860,184913,184914,184916,184917,184921,184922,184923,184939,184942,184963,184983,185054,185059,185099,185100,185104,185105,185106,185107,185126,185127,185141,185170,185171,185236,185237,185278,185279,185284,185289,185290,185291,185302,185305,185306,185309,185311,185359,185417,185418,185465,185469,185470,185471,185472,185473,185483,185484,185507,185538,185541,185544,185549,185550,185551,185597,185633,185646,185647,185648,185649,185695,185696,185756,185775,185776,185777,185787,185788,185789,185790,185840,185841,185842,185843,185854,185855,185859,185925,185926,185998,185999,186058,186209,186227,186228,186233,186234,186235,186332,186333,186358,186362,186363,186364,186367,186368,186370,186371,186447,186452,186479,186480,186518,186527,186528,186553,186583,186584,186585,186586,186597,186600,186633,186634,186654,186657,186660,186665,186749,186810,186811,186812,187013,187014,187015,187048,187071,187186,187187,187245,187485,187645,187817,188325,188980,189261,189330,189331,13278932, 
190380,190406,191076,190722,190725,190729,190742,191077,191078,191008,191248,191249,191889,191731,191730,191738,191888,191890,192148,192166,180747,182636,184905,185222,186466,188647,177775,190530,191633,191634,190905,190530,178293,180745,184904,185221,188646,176162,190532,191590,190880,178519,180746,182635,184903,185220,176100,168236,191592,190881,190533,184910,186468,188648,182346,190531,191631,191632,190892,190813,184906,185065,185224,186476,188649,181874,190534,191587,190897,190534,184907,185223,186467,188650,182232,170148,190536,191591,190939,184908,186469,182929,188651,188652,169062,166257,190543,191593,190882,183378,188653,190537,188626,186470,191589,190884,183726,190539,188654,185212,190538,190891,185639,185693,190898,185736,189299,185987,181051,181055,190542,191628,190906,185997,186145,186369, 192149,191624,190883,190541,187943,189311,191627,190890,189294,191588,190902,186700,187015,186750,191621,190907,186880,191622,190885,187928,191629,187938,191623,191630,189409,189649,190260,186991,166698,190258,189311,191627,190890,190386,190547,190635,190740,190738,190914,192447,189285,192445,192452,192441,192455,192437,192444,192446,192456,192439,192440,192443,192454,193956,192435,193950,193955,193948,192449,193932,193946,193942,193951,193148,193947,192457,193937,192458,191586,190886,193936,192438,193949,193935,193938,193943,193939,192442,193945,192459,193954,192451,193953,192450,192150,193940,193941,192383,193944,192448,191117,192376,193934,192059,193197,192781,193158,193246,193340,195038,195042,195054,195068,195037,195048,195052,195033,195035,195047,195063,195039,195064,195040,195045,195051,195053,195036,193952,195039,195046,195044,195041,195060,195043,195050,195056,195061,195049,195034,195051,195053,195058,195150,195059,195055,195062,193406,194001,194772,195150,195059,195034)
AND fr.fund_owner_email not like '%vmware%'
     AND fr.fund_owner_email not like '%internal%'
     AND fr.fund_owner_email not like '%test%'
     AND fr.fund_owner_email not like '%demo%'
     AND fr.fund_owner_email not like '%qa%'
     AND fr.fund_owner_email not like '%smoke%'
     --AND (fr.sku_description ilike '%govcloud%' OR
       --   fr.sku_description LIKE '%AWS%' OR
         -- fr.sku_description LIKE '%Cost Insight%' OR
          --fr.sku_description LIKE '%Network Insight%' OR
          --fr.sku_description LIKE '%Horizon%' OR
          --fr.sku_description ILIKE '%wavefront%')
   GROUP BY
            CASE
              WHEN (fr.sku_description ilike '%govcloud%') THEN 'AWS GovCloud'
              WHEN (fr.sku_description like '%AWS%') THEN 'AWS'
              WHEN (fr.sku_description like '%Cost Insight%') THEN 'Cost Insight'
              WHEN (fr.sku_description like '%Network Insight%') THEN 'Network Insight'
              WHEN (fr.sku_description LIKE '%Horizon%') THEN 'Horizon'
              WHEN (fr.sku_description ILIKE '%wavefront%') THEN 'Wavefront'
            END,
            fr.fund_name,
            fr.outstanding_balance,
            fr.fund_id,
            fr.ea_number,
            --si.account_name,
            ea.ent_account_name,
            fr.fund_owner_email,
            fr.currency,
            fr.fund_name,
           --fr.sku_description,
            fr.redemption_date,
            fr.billing_end_date,
            fr.billing_start_date,
            fr.group_id,
            fr.group_name,
            fr.sid,
            sppd.fund_start_date,
                       --to_date(((sppd.fund_start_date) :: character varying) :: text,
                        --('YYYY-MM-DD' :: character varying) :: text),           
            sppd.fund_end_date,
            sppd.tokens_purchased,
            sppd.tokens_remaining,
            fr.sku,
            fr.sku_description,
            sppd.disti_prm_id,
            sdpx.offer_type
      ORDER BY fr.redemption_date DESC
            )
,CTEB AS --Subquery to bring all results that have account_name as blank.
  (SELECT 1 AS RN,
    CTE.*
   FROM CTE
   JOIN
       (SELECT cte.ea_number
       --AVG (CAST(fr.ea_number AS INT))
        FROM CTE
        GROUP BY cte.ea_number
        HAVING COUNT(CTE.ea_number) = 1) AS A
          ON cte.ea_number = A.ea_number
          AND CTE.ea_name = '')
,CTEC AS --Subquery to eliminate duplicates
  (SELECT ROW_NUMBER() OVER (PARTITION BY ea_number, ea_name, fund_id, sid
                                   ORDER BY ea_name, fund_id) AS RN,
          *
        FROM CTE AS A
        WHERE A.ea_name != '')
SELECT * --Main query to join all results from CTEs
FROM CTEB
UNION ALL
SELECT *
FROM CTEC
WHERE RN = 1
