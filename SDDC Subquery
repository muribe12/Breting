
WITH mel AS
		(
			SELECT s.dim_org_id,
				o.aws_account_number,
				o.org_type,
				p.cloud_provider,
				p.cloud_provider_region,
				sum(s.host_count) as hours, 
				sum(s.host_count) * 3 as cost,
				min(s.ss__processed_ts) as start_date,
				max(s.ss__processed_ts) as end_date,
				CASE WHEN floor(datediff(min(s.ss__processed_ts), max(s.ss__processed_ts))) > 21 then '**MORE THAN 3 WEEKS**'
					WHEN floor(datediff(min(s.ss__processed_ts), max(s.ss__processed_ts))) > 14 then 'OVER 2 WEEKS'
				ELSE 'WITHIN 2 WEEKS' end as timing_status
			FROM vmc_dw.fact_sddc_daily s
				JOIN vmc_dw.dim_org o ON (s.dim_org_id = o.dim_org_id )
				JOIN vmc_dw.dim_sddc_h p ON (s.dim_org_id = p.dim_org_id)
			GROUP BY s.dim_org_id,o.aws_account_number,o.org_type,p.cloud_provider, p.cloud_provider_region 
)

SELECT tv.id, tv.compliance,tv.customer_name, tv.org_id, tv.region, 
		tv.se_specialist, tv.services, tv.status, tv.use_case, 'tv.timestamp', 
		COALESCE(tv.opportunity_id,tv.sfdc_oppty_id_raw) as 'opty_id',
		h.dim_org_id, h.aws_account_number, h.org_type, h.hours, h.cost, h.start_date, 
		h.end_date, h.timing_status
		FROM history.vmc_set_tech_validation tv
		LEFT JOIN mel h ON (tv.org_id = h.dim_org_id)
